name: Simple Deploy to TimeWeb

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-and-notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run basic tests
      run: |
        # Test imports from backend directory
        cd backend
        export PYTHONPATH=$PWD:$PYTHONPATH
        python3 -c "from main import app; print('âœ… FastAPI app works')"
        python3 -c "from core.config import settings; print('âœ… Config works')"

    - name: Trigger TimeWeb deployment
      if: success()
      env:
        TIMEWEB_WEBHOOK: ${{ secrets.TIMEWEB_WEBHOOK }}
      run: |
        if [ ! -z "$TIMEWEB_WEBHOOK" ]; then
          # Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ webhook Ð¾Ñ‚ TimeWeb
          curl -X POST "$TIMEWEB_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d '{"ref":"main","repository":"trenergram"}'
          echo "âœ… Triggered TimeWeb deployment via webhook"
        else
          echo "â„¹ï¸ TimeWeb webhook not configured, relying on auto-deploy"
        fi

    - name: Summary
      run: |
        echo "### ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Code tests passed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Pushed to main branch" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "TimeWeb should auto-deploy from GitHub" >> $GITHUB_STEP_SUMMARY
        echo "Check deployment at: https://your-app.timeweb.cloud" >> $GITHUB_STEP_SUMMARY