server {
    listen 80;
    server_name trenergram.ru www.trenergram.ru;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name trenergram.ru www.trenergram.ru;

    ssl_certificate /etc/letsencrypt/live/trenergram.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/trenergram.ru/privkey.pem;

    # Temporary root page
    location = / {
        default_type text/html;
        return 200 '<html><body style="font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#f5f5f5"><div style="text-align:center"><h1>Trenergram</h1><p>Платформа для записи на тренировки</p><p style="color:#666;margin-top:20px">Скоро здесь будет веб-витрина</p><p style="margin-top:30px"><a href="/trainer/" style="color:#0088cc">Mini App (тестовая версия)</a></p></div></body></html>';
    }

    # Mini App
    location /trainer/ {
        alias /var/www/trenergram/;
        try_files $uri $uri/ /trainer/index.html;
    }

    # API proxy
    location /api/ {
        proxy_pass http://localhost:8000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Health check
    location /health {
        proxy_pass http://localhost:8000/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Future paths
    location /club-admin {
        default_type text/html;
        return 200 '<html><body style="font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100vh;margin:0"><h2>Панель администратора клуба (в разработке)</h2></body></html>';
    }

    location /admin {
        default_type text/html;
        return 200 '<html><body style="font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100vh;margin:0"><h2>Админка (в разработке)</h2></body></html>';
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
}